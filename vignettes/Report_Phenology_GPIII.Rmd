---
title: "Report_Phenology_GPIII"
author: "Dario Maccioni Vasquez"
date: "`r Sys.Date()`"
output: html_document
---


Search for all products in MODISTools and get the right one

```{r}
# load the library
library("MODISTools")

# list all available products
# (only showing first part of the table for brevity)
MODISTools::mt_products() |> 
  head()

View(mt_products())
```

Select from the chosen products the right bands, which are Greenup.Num_Modes_01 and Maturity.Num_Modes_01.

```{r}
# list bands for the MOD11A2
# product (a land surface temperature product)
MODISTools::mt_bands("MCD12Q2") |> 
  head()

View(mt_bands("MCD12Q2"))

```

Download Greenup Phenology

```{r}
# load libraries
library(MODISTools)

# download and save phenology data
Greenup <- MODISTools::mt_subset(
  product = "MCD12Q2",
  lat = 43.5,
  lon = 74.5,
  band = "Greenup.Num_Modes_01",
  start = "2001-01-01",
  end = "2009-12-31",
  km_lr = 100,
  km_ab = 100,
  site_name = "Adirondacks (North-Eastern United States)",
  internal = TRUE,
  progress = FALSE)

# print the dowloaded data
head(subset)
```


Search for bands in land cover product

```{r}
# list bands for the MOD11A2
# product (a land surface temperature product)
MODISTools::mt_bands("MCD12Q1") |> 
  head()

View(mt_bands("MCD12Q1"))

```


Nur IGBF Klassen herunerladen
```{r}
# load libraries
library(MODISTools)

# download and save phenology data
IGBP <- MODISTools::mt_subset(
  product = "MCD12Q1",
  lat = 43.5,
  lon = 74.5,
  band = "LC_Type1",
  start = "2010-01-01",
  end = "2010-12-31",
  km_lr = 100,
  km_ab = 100,
  site_name = "Adirondacks (North-Eastern United States)",
  internal = TRUE,
  progress = FALSE)

# print the dowloaded data
head(subset)
```

Aus Data Frame Daten filtern (NA werte)

```{r}
library(dplyr)
library(terra)
```

```{r}
library(dplyr)

Greenup <- Greenup |> 
  mutate(
    value = ifelse(value > 32656, NA, value),
    doy = as.numeric(format(as.Date("2010-01-01") + value, "%j")),
    doy = ifelse(doy < 200, doy, NA),
    year = format(as.Date(calendar_date), "%Y")
  )
```

```{r}
# screening of data
Greenup <- Greenup |>
  mutate(
    value = ifelse(value > 32656, NA, value),
    value = as.numeric(format(as.Date("2010-01-01") + value, "%j")),
    value = ifelse (value < 200, value, NA)
  )
```

Data Frame zu Raster

```{r}
Greenup_raster <- MODISTools::mt_to_terra(
  Greenup,
  reproject = TRUE
)
```


Plot Raster File

```{r}
install.packages("tidyterra", type = "binary")
```

```{r}
library(ggplot2)
library(terra)
library(tidyterra)
```

```{r}
ggplot() +
  tidyterra::geom_spatraster(data = Greenup_raster) +
  scale_fill_viridis_c(
    na.value = NA,
    name = "DOY"
    ) +
  theme_bw()
```
LTM und SD berrechnung (--> weitere Literatur dazu finden)
```{r}
# Greenup: nur 2001â€“2009
Greenup_ltm <- Greenup |>
  filter(year >= 2001 & year <= 2009) |>
  group_by(latitude, longitude) |>
  summarise(
    ltm = mean(doy, na.rm = TRUE),
    sd = sd(doy, na.rm = TRUE),
    .groups = "drop"
  )
```

early Greenup
```{r}
# Greenup 2010
Greenup_2009 <- Greenup |> filter(year == 2009)

Greenup_eval <- Greenup_2009 |>
  left_join(Greenup_ltm, by = c("latitude", "longitude")) |>
  mutate(early_greenup = doy < (ltm - sd))
```

```{r}
Greenup_eval_clean <- Greenup_eval |> 
  dplyr::filter(!is.na(early_numeric))

```

Raster von LTM, SD und early Greenup

```{r}
Greenup_eval$early_numeric <- as.integer(Greenup_eval$early_greenup)
```

```{r}
library(terra)

Early_Greenup_raster <- MODISTools::mt_to_terra(
  Greenup_eval_clean,
  reproject = TRUE
)


plot(Early_Greenup_raster, main = "Early Greenup 2010 (< LTM - SD)")

```



```{r}
library(tidyterra)
library(ggplot2)

ggplot() +
  geom_spatraster(data = Early_Greenup_raster) +
  scale_fill_manual(
    values = c("white", "darkgreen"),  # 0 = white, 1 = darkgreen
    name = "Early Greenup"
  ) +
  theme_bw()
```

